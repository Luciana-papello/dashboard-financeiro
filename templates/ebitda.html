{% extends "base.html" %}

{% block title %}Análise EBITDA - Dashboard Financeiro{% endblock %}

{% block page_title %}Análise EBITDA{% endblock %}

{% block content %}
<div class="container-fluid animate-fade-in">
    
    <!-- Seleção de Período -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-calendar-alt me-2"></i>Selecione o Período
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="mes" class="form-label">Mês</label>
                            <select class="form-select" id="mes">
                                <option value="">Selecione...</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="ano" class="form-label">Ano</label>
                            <select class="form-select" id="ano">
                                <option value="">Selecione...</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary w-100" onclick="carregarEbitda()">
                                <i class="fas fa-search me-2"></i>Visualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- KPIS PRINCIPAIS -->
<div class="row mb-4" id="kpisEbitdaContainer" style="display: none;">
        <div class="col-md-3 mb-3">
            <div class="card kpi-card">
                <div class="kpi-content">
                    <div class="kpi-label">EBITDA</div>
                    <div class="kpi-value" id="kpiEbitdaValor">-</div>
                    <div class="kpi-subtext">Lucro Operacional Bruto</div>
                </div>
                <i class="fas fa-layer-group kpi-icon-bg"></i>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card kpi-card">
                <div class="kpi-content">
                    <div class="kpi-label">Margem EBITDA</div>
                    <div class="kpi-value" id="kpiMargemEbitda">-</div>
                    <div class="kpi-subtext">% da Receita</div>
                </div>
                <i class="fas fa-percentage kpi-icon-bg"></i>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card kpi-card">
                <div class="kpi-content">
                    <div class="kpi-label">Receita Operacional</div>
                    <div class="kpi-value" id="kpiReceita">-</div>
                    <div class="kpi-subtext">Faturamento Total</div>
                </div>
                <i class="fas fa-hand-holding-usd kpi-icon-bg"></i>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card kpi-card">
                <div class="kpi-content">
                    <div class="kpi-label">Res. Operacional</div>
                    <div class="kpi-value" id="kpiResultadoOp">-</div>
                    <div class="kpi-subtext">Antes dos Ajustes</div>
                </div>
                <i class="fas fa-chart-line kpi-icon-bg"></i>
            </div>
        </div>
    </div>

    
    <!-- SEÇÃO 1: Análise EBITDA -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Análise EBITDA</h5>
                </div>
                <div class="card-body">
                    <div id="secaoEbitda">
                        <p class="text-center text-muted">Selecione um período para visualizar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEÇÃO 2: Composição do Ativo Circulante -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>Composição do Ativo Circulante</h5>
                </div>
                <div class="card-body">
                    <div id="secaoAtivo">
                        <p class="text-center text-muted">Selecione um período para visualizar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEÇÃO 3: Capital Circulante -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Capital Circulante</h5>
                </div>
                <div class="card-body">
                    <div id="secaoCapital">
                        <p class="text-center text-muted">Selecione um período para visualizar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEÇÃO 4: Índices e Prazos Médios -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Índices e Prazos Médios</h5>
                </div>
                <div class="card-body">
                    <div id="secaoIndices">
                        <p class="text-center text-muted">Selecione um período para visualizar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}

function formatarPercentual(valor, base) {
    if (!base || base === 0) return '0.00%';
    const perc = (valor / base) * 100;
    return perc.toFixed(2) + '%';
}

async function carregarEbitda() {
    const mes = document.getElementById('mes').value;
    const ano = document.getElementById('ano').value;

    if (!mes || !ano) {
        alert('Selecione mês e ano!');
        return;
    }

    try {
        // Buscar valores
        const resValores = await fetch(`/api/valores/${mes}/${ano}`);
        const valores = await resValores.json();

        // Buscar resumo de NF-e
        const resNFe = await fetch(`/api/nfe/resumo/${mes}/${ano}`);
        const nfeResumo = await resNFe.json();

        // Renderizar seções
        renderizarSecaoEbitda(valores);
        renderizarSecaoAtivo(valores);
        renderizarSecaoCapital(valores);
        renderizarSecaoIndices(valores, nfeResumo);

    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar dados!');
    }
}
async function carregarEbitda() {
        const mes = document.getElementById('mes').value;
        const ano = document.getElementById('ano').value;

        if (!mes || !ano) {
            alert('Selecione mês e ano!');
            return;
        }

        try {
            // Buscar valores
            const resValores = await fetch(`/api/valores/${mes}/${ano}`);
            const valores = await resValores.json();

            // Buscar resumo de NF-e
            const resNFe = await fetch(`/api/nfe/resumo/${mes}/${ano}`);
            const nfeResumo = await resNFe.json();

            // Renderizar KPIs no Topo
            renderizarKPIs(valores);

            // Renderizar seções existentes
            renderizarSecaoEbitda(valores);
            renderizarSecaoAtivo(valores);
            renderizarSecaoCapital(valores);
            renderizarSecaoIndices(valores, nfeResumo);

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao carregar dados!');
        }
    }

    function renderizarKPIs(valores) {
        document.getElementById('kpisEbitdaContainer').style.display = 'flex';

        const receita = valores[1] || 0;
        const ebitda = valores[21] || 0;
        const resultadoOp = valores[18] || 0;
        
        // Cálculo da Margem EBITDA
        const margem = receita !== 0 ? (ebitda / receita) * 100 : 0;

        // Função auxiliar para atualizar com cor
        const atualizarKPI = (id, valor, isPercentual = false) => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = isPercentual ? valor : formatarMoeda(valor);
                
                // Verifica se é negativo (para percentual, checa o valor numérico original)
                const numCheck = isPercentual ? parseFloat(valor) : valor;
                el.style.color = numCheck < 0 ? '#ff6b6b' : '';
            }
        };

        atualizarKPI('kpiEbitdaValor', ebitda);
        atualizarKPI('kpiMargemEbitda', margem.toFixed(2) + '%', true);
        atualizarKPI('kpiReceita', receita);
        atualizarKPI('kpiResultadoOp', resultadoOp);
    }

function renderizarSecaoEbitda(valores) {
        const receita = valores[1] || 0;
        
        let html = '<table class="table table-dark">';
        html += '<thead><tr><th>CONTA</th><th class="text-end">VALOR</th><th class="text-end">%</th></tr></thead>';
        html += '<tbody>';
        
        const contas = [
            { id: 18, nome: 'Resultado Operacional' },
            { id: 19, nome: 'Despesas Financeiras' },
            { id: 20, nome: 'Depreciações' },
            { id: 21, nome: 'EBITDA' }
        ];
        
        contas.forEach(conta => {
            const valor = valores[conta.id] || 0;
            const percentual = formatarPercentual(valor, receita);
            const isEbitda = conta.id === 21;
            
            // --- LÓGICA DE COR CORRIGIDA ---
            let estiloCor = '';
            if (valor < 0) {
                estiloCor = 'style="color: #ff6b6b !important;"';
            } else if (isEbitda) {
                estiloCor = 'style="color: var(--color-green-primary);"';
            }
            
            const classe = isEbitda ? 'fw-bold' : '';
            
            html += `
                <tr ${isEbitda ? 'style="background-color: rgba(150, 202, 0, 0.1);"' : ''}>
                    <td class="${classe}" ${estiloCor}>${conta.nome}</td>
                    <td class="text-end ${classe}" ${estiloCor}>${formatarMoeda(valor)}</td>
                    <td class="text-end ${classe}" ${estiloCor}>${percentual}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('secaoEbitda').innerHTML = html;
    }

function renderizarSecaoAtivo(valores) {
        const ativoCirculante = valores[52] || 0;
        
        let html = '<table class="table table-dark">';
        html += '<thead><tr><th>CONTA</th><th class="text-end">VALOR</th><th class="text-end">%</th></tr></thead>';
        html += '<tbody>';
        
        const contas = [
            { id: 37, nome: 'Disponível' },
            { id: 45, nome: 'Créditos' },
            { id: 51, nome: 'Estoques' },
            { id: 52, nome: 'TOTAL DO ATIVO CIRCULANTE' }
        ];
        
        contas.forEach(conta => {
            const valor = valores[conta.id] || 0;
            const percentual = conta.id === 52 ? '100.00%' : formatarPercentual(valor, ativoCirculante);
            const isTotal = conta.id === 52;
            
            // --- LÓGICA DE COR CORRIGIDA ---
            let estiloCor = '';
            if (valor < 0) {
                estiloCor = 'style="color: #ff6b6b !important;"';
            } else if (isTotal) {
                estiloCor = 'style="color: var(--color-green-primary);"';
            }
            
            const classe = isTotal ? 'fw-bold' : '';
            
            html += `
                <tr ${isTotal ? 'style="background-color: rgba(150, 202, 0, 0.1);"' : ''}>
                    <td class="${classe}" ${estiloCor}>${conta.nome}</td>
                    <td class="text-end ${classe}" ${estiloCor}>${formatarMoeda(valor)}</td>
                    <td class="text-end ${classe}" ${estiloCor}>${percentual}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('secaoAtivo').innerHTML = html;
    }

function renderizarSecaoCapital(valores) {
    let html = '<table class="table table-dark">';
    html += '<thead><tr><th>CONTA</th><th class="text-end">VALOR</th></tr></thead>';
    html += '<tbody>';
    
    const contas = [
        { id: 52, nome: 'Ativo Circulante' },
        { id: 71, nome: 'Passivo Circulante' },
        { id: 87, nome: 'CAPITAL CIRCULANTE' }
    ];
    
    contas.forEach(conta => {
        const valor = valores[conta.id] || 0;
        const isTotal = conta.id === 87;
        
        html += `
            <tr ${isTotal ? 'style="background-color: rgba(150, 202, 0, 0.1);"' : ''}>
                <td ${isTotal ? 'class="fw-bold" style="color: var(--color-green-primary);"' : ''}>${conta.nome}</td>
                <td class="text-end ${isTotal ? 'fw-bold' : ''}">${formatarMoeda(valor)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    document.getElementById('secaoCapital').innerHTML = html;
}

function renderizarSecaoIndices(valores, nfeResumo) {
    let html = '<table class="table table-dark">';
    html += '<thead><tr><th>ÍNDICE</th><th class="text-end">VALOR</th><th>DESCRIÇÃO</th></tr></thead>';
    html += '<tbody>';
    
    // Liquidez Corrente
    html += `
        <tr>
            <td>Liquidez Corrente</td>
            <td class="text-end fw-bold">${(valores[84] || 0).toFixed(2)}</td>
            <td class="text-muted">Ativo Circulante / Passivo Circulante</td>
        </tr>
    `;
    
    // Liquidez Seca
    html += `
        <tr>
            <td>Liquidez Seca</td>
            <td class="text-end fw-bold">${(valores[85] || 0).toFixed(2)}</td>
            <td class="text-muted">(Ativo - Estoques - Adiant.) / Passivo Circulante</td>
        </tr>
    `;
    
    // Prazo Médio Recebimento
    html += `
        <tr>
            <td>Prazo Médio Recebimento</td>
            <td class="text-end fw-bold">${(valores[93] || 0).toFixed(2)} dias</td>
            <td class="text-muted">Contas a Receber / Receita Diária</td>
        </tr>
    `;
    
    // Prazo Médio Pagamento
    html += `
        <tr>
            <td>Prazo Médio Pagamento</td>
            <td class="text-end fw-bold">${(valores[94] || 0).toFixed(2)} dias</td>
            <td class="text-muted">Fornecedores / Compras Diárias</td>
        </tr>
    `;
    
    // Compras do Mês
    html += `
        <tr style="background-color: rgba(150, 202, 0, 0.1);">
            <td class="fw-bold" style="color: var(--color-green-primary);">Compras do Mês</td>
            <td class="text-end fw-bold" style="color: var(--color-green-primary);">${formatarMoeda(valores[95] || 0)}</td>
            <td class="text-muted">${nfeResumo.quantidade || 0} NF-e de Entrada</td>
        </tr>
    `;
    
    html += '</tbody></table>';
    document.getElementById('secaoIndices').innerHTML = html;
}



// Auto-carregar último mês disponível
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/dashboard/ultimos-meses');
            const data = await response.json();
            
            if (data.length > 0) {
                const ultimo = data[0];
                document.getElementById('mes').value = ultimo.mes;
                document.getElementById('ano').value = ultimo.ano;
                
                // Chama a função específica desta tela
                await carregarEbitda();
            }
        } catch (error) {
            console.error('Erro ao carregar dados iniciais:', error);
        }
    });

</script>
{% endblock %}